name: Update Unlock Data

on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch unlock data and generate data.js
        env:
          COINGLASS_API_KEY: ${{ secrets.COINGLASS_API_KEY }}
        run: |
          node << 'EOF'
          const https = require('https');
          const fs = require('fs');

          const API_KEY = process.env.COINGLASS_API_KEY;
          const BASE_URL = 'open-api-v4.coinglass.com';

          function fetchJSON(path) {
            return new Promise((resolve, reject) => {
              const options = {
                hostname: BASE_URL,
                path,
                method: 'GET',
                headers: {
                  'CG-API-KEY': API_KEY,
                  'Content-Type': 'application/json',
                },
              };
              const req = https.request(options, res => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try { resolve(JSON.parse(data)); }
                  catch (e) { reject(new Error(`Failed to parse JSON: ${data.slice(0,200)}`)); }
                });
              });
              req.on('error', reject);
              req.setTimeout(15000, () => { req.destroy(); reject(new Error('Request timeout')); });
              req.end();
            });
          }

          const sleep = ms => new Promise(r => setTimeout(r, ms));

          const VESTING_USD_THRESHOLD = 100000;
          const VESTING_PCT_THRESHOLD = 0.5;

          async function main() {
            console.log('Fetching token unlock list...');
            const listRes = await fetchJSON('/api/coin/unlock-list');

            if (listRes.code !== '0' || !Array.isArray(listRes.data)) {
              throw new Error(`Unexpected response: ${JSON.stringify(listRes).slice(0,300)}`);
            }

            console.log(`Total tokens from API: ${listRes.data.length}`);

            // Dedupe by symbol only, no date filtering
            const seen = new Set();
            const tokens = listRes.data.filter(t => {
              if (!t.next_unlock_date) return false;
              if (seen.has(t.symbol)) return false;
              seen.add(t.symbol);
              return true;
            });

            console.log(`Kept ${tokens.length} tokens after dedup`);

            const normalized = tokens.map(t => ({
              symbol:             t.symbol,
              name:               t.name,
              price:              t.price || 0,
              price_change_24h:   t.price_change_percent_24h ?? null,
              market_cap:         t.market_cap || 0,
              next_unlock_date:   t.next_unlock_date,
              next_unlock_usd:    t.next_unlock_usd || 0,
              next_unlock_tokens: t.next_unlock_tokens || 0,
              pct_circ:           t.next_unlock_of_circulating || 0,
              pct_supply:         t.next_unlock_of_supply || 0,
              allocation_type:    null,
              vesting_type:       null,
            }));

            const significant = normalized.filter(t =>
              t.next_unlock_usd >= VESTING_USD_THRESHOLD ||
              t.pct_circ >= VESTING_PCT_THRESHOLD
            );

            console.log(`Fetching vesting detail for ${significant.length} significant tokens...`);

            for (const token of significant) {
              try {
                await sleep(300);
                console.log(`  -> ${token.symbol}`);
                const vestRes = await fetchJSON(`/api/token-vesting?symbol=${token.symbol}`);
                if (vestRes.code === '0' && vestRes.data) {
                  const activeAlloc = (vestRes.data.allocations || []).find(a =>
                    !a.is_untracked &&
                    a.next_unlock &&
                    a.next_unlock.date === token.next_unlock_date
                  );
                  if (activeAlloc) {
                    token.allocation_type = activeAlloc.name;
                    token.vesting_type    = activeAlloc.unlock_type || null;
                  }
                }
              } catch (err) {
                console.warn(`  Failed vesting for ${token.symbol}: ${err.message}`);
              }
            }

            const meta = {
              generated_at: new Date().toISOString(),
              token_count:  normalized.length,
              source:       'Coinglass API v4',
            };

            const output = [
              `// Auto-generated by GitHub Actions â€” do not edit manually`,
              `// Last updated: ${meta.generated_at}`,
              `const UNLOCK_DATA = ${JSON.stringify(normalized, null, 2)};`,
              `const UNLOCK_META = ${JSON.stringify(meta, null, 2)};`,
            ].join('\n\n');

            fs.writeFileSync('data.js', output, 'utf8');
            console.log(`Done. Wrote data.js with ${normalized.length} tokens`);
          }

          main().catch(err => {
            console.error('Fatal error:', err);
            process.exit(1);
          });
          EOF

      - name: Commit and push data.js
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.js
          git diff --staged --quiet || git commit -m "chore: update unlock data $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push
