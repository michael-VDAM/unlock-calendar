<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Token Unlock Calendar</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #070710; --bg2: #0c0c18; --border: #252538; --border2: #2a2a42;
      --text: #f0f0f0; --text2: #aaa; --text3: #6a6a9a;
      --mono: 'IBM Plex Mono', monospace; --sans: 'IBM Plex Sans', sans-serif;
      --red: #ff4040; --orange: #ff8c00; --yellow: #e8c547; --blue: #4a8fff; --green: #3d9e6e;
    }
    body { background: var(--bg); color: var(--text); font-family: var(--mono); min-height: 100vh; padding: 28px; }
    ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

    .header { margin-bottom: 24px; }
    .header-eyebrow { font-size: 9px; color: var(--text3); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 8px; }
    .header-row { display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 12px; }
    .header-title { font-family: var(--sans); font-size: 26px; font-weight: 700; color: #f2f2f2; }
    .header-sub { font-size: 11px; color: var(--text3); margin-top: 3px; }
    .header-meta { font-size: 10px; color: var(--text3); margin-top: 2px; }
    .view-toggle { display: flex; gap: 4px; }
    .view-btn { padding: 5px 14px; border: 1px solid var(--border2); border-radius: 3px; font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; font-family: var(--mono); background: none; color: var(--text3); cursor: pointer; }
    .view-btn.active { border-color: var(--blue); color: var(--blue); }

    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
    .stat-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; padding: 14px 16px; }
    .stat-label { font-size: 9px; color: var(--text3); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; }
    .stat-value { font-family: var(--sans); font-size: 24px; font-weight: 600; color: #f0f0f0; line-height: 1; }
    .stat-sub { font-size: 10px; color: var(--text3); margin-top: 5px; }

    .controls { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .control-group { display: flex; align-items: center; gap: 8px; }
    .control-label { font-size: 9px; color: var(--text3); letter-spacing: 2px; text-transform: uppercase; }
    select { background: var(--bg2); border: 1px solid var(--border2); color: #bbb; padding: 4px 8px; border-radius: 3px; font-size: 11px; font-family: var(--mono); outline: none; cursor: pointer; }
    .legend { margin-left: auto; display: flex; gap: 14px; align-items: center; }
    .legend-item { display: flex; gap: 5px; align-items: center; }
    .legend-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .legend-label { font-size: 9px; color: var(--text3); letter-spacing: 1px; }

    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .cal-header { text-align: center; font-size: 9px; color: var(--text3); letter-spacing: 2px; padding-bottom: 8px; }
    .cal-empty { min-height: 86px; }
    .cal-day { background: #0a0a12; border: 1px solid var(--border); border-radius: 5px; padding: 9px; min-height: 86px; }
    .cal-day.has-events { cursor: pointer; }
    .cal-day.has-events:hover { border-color: rgba(255,255,255,0.25); }
    .cal-day.selected { outline: 1px solid rgba(74,143,255,0.3); }
    .cal-day-num { font-size: 12px; color: #777; display: flex; justify-content: space-between; align-items: flex-start; }
    .cal-day-num.today { color: #fff; font-weight: 600; }
    .cal-risk-dot { width: 5px; height: 5px; border-radius: 50%; margin-top: 3px; }
    .cal-usd { font-size: 10px; font-weight: 500; margin-top: 5px; }
    .cal-count { font-size: 9px; color: var(--text3); margin-top: 2px; }
    .cal-chips { margin-top: 5px; display: flex; flex-wrap: wrap; gap: 2px; }
    .cal-chip { font-size: 8px; background: rgba(255,255,255,0.07); padding: 1px 4px; border-radius: 2px; color: #888; }
    .cal-more { font-size: 8px; color: var(--text3); }

    .day-detail { margin-top: 16px; background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 18px 20px; }
    .day-detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
    .day-detail-title { font-size: 13px; color: #ccc; font-family: var(--sans); }
    .close-btn { background: none; border: 1px solid var(--border2); color: var(--text3); padding: 3px 10px; border-radius: 3px; cursor: pointer; font-size: 10px; font-family: var(--mono); }

    .list-date-block { margin-bottom: 28px; }
    .list-date-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
    .list-date-label { font-size: 12px; color: #999; }
    .list-date-total { font-size: 11px; color: var(--text3); }

    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 11px; }
    thead tr { border-bottom: 1px solid var(--border); }
    th { text-align: left; padding: 5px 10px; font-size: 8px; color: var(--text3); letter-spacing: 2px; text-transform: uppercase; font-weight: 400; }
    tbody tr { border-bottom: 1px solid #0e0e18; }
    tbody tr:hover { background: rgba(255,255,255,0.03); }
    td { padding: 8px 10px; }
    .td-risk { display: flex; align-items: center; gap: 5px; }
    .td-risk-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
    .td-risk-label { font-size: 8px; letter-spacing: 1px; }
    .td-symbol { font-weight: 600; font-size: 12px; color: #e8e8e8; }
    .td-name { font-size: 9px; color: var(--text3); margin-top: 1px; }
    .td-usd { color: #f0f0f0; font-weight: 600; font-size: 12px; }
    .td-bar-wrap { display: flex; align-items: center; gap: 7px; }
    .td-bar-bg { width: 44px; height: 2px; background: #1a1a28; border-radius: 1px; overflow: hidden; flex-shrink: 0; }
    .td-bar-fill { height: 100%; border-radius: 1px; }
    .td-alloc { font-size: 10px; color: #999; }
    .empty { text-align: center; color: var(--text3); padding: 60px 0; font-size: 12px; }

    @media (max-width: 800px) {
      .stats { grid-template-columns: repeat(2, 1fr); }
      .legend { display: none; }
      body { padding: 16px; }
    }
  </style>
</head>
<body>
<div id="app"></div>
<script src="data.js"></script>
<script>
const fmt = n => n >= 1e6 ? `$${(n/1e6).toFixed(2)}M` : n >= 1e3 ? `$${(n/1e3).toFixed(0)}K` : `$${n.toFixed(0)}`;
const fmtPct = n => `${n.toFixed(2)}%`;
const fmtTokens = n => n >= 1e6 ? `${(n/1e6).toFixed(2)}M` : n >= 1e3 ? `${(n/1e3).toFixed(0)}K` : n.toFixed(0);
const fmtPrice = p => p < 0.001 ? p.toFixed(6) : p < 0.01 ? p.toFixed(5) : p < 1 ? p.toFixed(4) : p.toFixed(2);

const RISK = {
  critical: { color: '#ff4040', bg: 'rgba(255,64,64,0.08)',  border: 'rgba(255,64,64,0.3)',  label: 'CRIT' },
  high:     { color: '#ff8c00', bg: 'rgba(255,140,0,0.07)',  border: 'rgba(255,140,0,0.25)', label: 'HIGH' },
  medium:   { color: '#e8c547', bg: 'rgba(232,197,71,0.06)', border: 'rgba(232,197,71,0.22)',label: 'MED'  },
  low:      { color: '#4a8fff', bg: 'rgba(74,143,255,0.04)', border: 'rgba(74,143,255,0.18)',label: 'LOW'  },
};
const RISK_ORDER = ['low','medium','high','critical'];

function getRisk(usd, pct) {
  if (pct >= 2   || usd >= 1000000) return 'critical';
  if (pct >= 0.5 || usd >= 250000)  return 'high';
  if (pct >= 0.1 || usd >= 50000)   return 'medium';
  return 'low';
}
function topRisk(tokens) {
  return tokens.reduce((top, t) => {
    const r = getRisk(t.next_unlock_usd, t.pct_circ);
    return RISK_ORDER.indexOf(r) > RISK_ORDER.indexOf(top) ? r : top;
  }, 'low');
}

let state = { view: 'calendar', selectedDay: null, minUsd: 0, minPct: 0, sortBy: 'usd' };

const rawData = (typeof UNLOCK_DATA !== 'undefined') ? UNLOCK_DATA : [];
const meta    = (typeof UNLOCK_META !== 'undefined') ? UNLOCK_META : null;

// Window: 7 days ago through 180 days from now
const windowStart = new Date(); windowStart.setDate(windowStart.getDate() - 7); windowStart.setHours(0,0,0,0);
const windowEnd   = new Date(); windowEnd.setDate(windowEnd.getDate() + 180);   windowEnd.setHours(23,59,59,999);
const today = new Date(); today.setHours(0,0,0,0);
const todayKey = today.toISOString().split('T')[0];

function getFiltered() {
  return rawData.filter(d => {
    const dt = new Date(d.next_unlock_date);
    return d.next_unlock_usd >= state.minUsd
      && d.pct_circ >= state.minPct
      && dt >= windowStart
      && dt <= windowEnd;
  });
}

function groupByDate(data) {
  const map = {};
  for (const d of data) {
    const key = new Date(d.next_unlock_date).toISOString().split('T')[0];
    if (!map[key]) map[key] = [];
    map[key].push(d);
  }
  return map;
}

function sortTokens(arr) {
  return [...arr].sort((a,b) => state.sortBy === 'usd' ? b.next_unlock_usd - a.next_unlock_usd : b.pct_circ - a.pct_circ);
}

function render() {
  const filtered  = getFiltered();
  const grouped   = groupByDate(filtered);
  const sortedDates = Object.keys(grouped).sort();
  const totalUsd  = filtered.reduce((s,d) => s + d.next_unlock_usd, 0);
  const critCount = filtered.filter(d => getRisk(d.next_unlock_usd, d.pct_circ) === 'critical').length;
  const highCount = filtered.filter(d => getRisk(d.next_unlock_usd, d.pct_circ) === 'high').length;
  const biggest   = filtered.reduce((m,d) => d.next_unlock_usd > (m?.next_unlock_usd||0) ? d : m, null);

  // Build calendar days: start from Monday of this week, show enough weeks to cover 180 days
  const calStart = new Date(today);
  calStart.setDate(calStart.getDate() - ((calStart.getDay() + 6) % 7)); // back to Monday
  const calEnd = new Date(windowEnd);
  // Pad to end of week
  calEnd.setDate(calEnd.getDate() + (6 - (calEnd.getDay() + 6) % 7));

  const calDays = [];
  const d = new Date(calStart);
  while (d <= calEnd) {
    const key = d.toISOString().split('T')[0];
    calDays.push({ date: new Date(d), key, tokens: sortTokens(grouped[key]||[]) });
    d.setDate(d.getDate() + 1);
  }

  document.getElementById('app').innerHTML = `
    <div class="header">
      <div class="header-eyebrow">coinglass · token unlock tracker</div>
      <div class="header-row">
        <div>
          <div class="header-title">Unlock Calendar</div>
          <div class="header-sub">Next 180 days</div>
          ${meta ? `<div class="header-meta">Updated: ${new Date(meta.generated_at).toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit',timeZoneName:'short'})}</div>` : ''}
        </div>
        <div class="view-toggle">
          <button class="view-btn ${state.view==='calendar'?'active':''}" onclick="setState({view:'calendar',selectedDay:null})">Calendar</button>
          <button class="view-btn ${state.view==='list'?'active':''}" onclick="setState({view:'list',selectedDay:null})">List</button>
        </div>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card"><div class="stat-label">Total Unlock Value</div><div class="stat-value">${fmt(totalUsd)}</div><div class="stat-sub">across ${filtered.length} tokens</div></div>
      <div class="stat-card"><div class="stat-label">Critical Events</div><div class="stat-value" style="color:var(--red)">${critCount}</div><div class="stat-sub">&gt;$1M or &gt;2% circ</div></div>
      <div class="stat-card"><div class="stat-label">High Risk Events</div><div class="stat-value" style="color:var(--orange)">${highCount}</div><div class="stat-sub">&gt;$250K or &gt;0.5% circ</div></div>
      <div class="stat-card"><div class="stat-label">Largest Unlock</div><div class="stat-value">${biggest ? fmt(biggest.next_unlock_usd) : '—'}</div><div class="stat-sub">${biggest?.symbol||''}</div></div>
    </div>

    <div class="controls">
      <div class="control-group">
        <span class="control-label">Min USD</span>
        <select onchange="setState({minUsd:+this.value,selectedDay:null})">
          ${[[0,'All'],[10000,'$10K+'],[50000,'$50K+'],[100000,'$100K+'],[250000,'$250K+'],[500000,'$500K+'],[1000000,'$1M+']].map(([v,l])=>`<option value="${v}" ${state.minUsd==v?'selected':''}>${l}</option>`).join('')}
        </select>
      </div>
      <div class="control-group">
        <span class="control-label">Min % Circ</span>
        <select onchange="setState({minPct:+this.value,selectedDay:null})">
          ${[[0,'All'],[0.1,'0.1%+'],[0.5,'0.5%+'],[1,'1%+'],[2,'2%+'],[3,'3%+']].map(([v,l])=>`<option value="${v}" ${state.minPct==v?'selected':''}>${l}</option>`).join('')}
        </select>
      </div>
      <div class="control-group">
        <span class="control-label">Sort</span>
        <select onchange="setState({sortBy:this.value,selectedDay:null})">
          <option value="usd" ${state.sortBy==='usd'?'selected':''}>USD Value</option>
          <option value="pct" ${state.sortBy==='pct'?'selected':''}>% Circ</option>
        </select>
      </div>
      <div class="legend">
        ${Object.entries(RISK).map(([k,v])=>`<div class="legend-item"><div class="legend-dot" style="background:${v.color}"></div><span class="legend-label">${v.label}</span></div>`).join('')}
      </div>
    </div>

    ${state.view === 'calendar' ? `
      <div class="cal-grid">
        ${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map(d=>`<div class="cal-header">${d}</div>`).join('')}
        ${calDays.map(({date,key,tokens}) => {
          const hasEv = tokens.length > 0;
          const risk  = topRisk(tokens);
          const cfg   = RISK[risk];
          const dayUsd = tokens.reduce((s,t)=>s+t.next_unlock_usd,0);
          const isToday = key === todayKey;
          const isSel   = state.selectedDay === key;
          return `<div class="cal-day ${hasEv?'has-events':''} ${isSel?'selected':''}"
            style="${hasEv?`background:${cfg.bg};border-color:${isSel?cfg.color:cfg.border}`:''}"
            ${hasEv?`onclick="toggleDay('${key}')"`:''}>
            <div class="cal-day-num ${isToday?'today':''}">
              <span>${date.getDate()}</span>
              ${hasEv?`<div class="cal-risk-dot" style="background:${cfg.color}"></div>`:''}
            </div>
            ${hasEv?`
              <div class="cal-usd" style="color:${cfg.color}">${fmt(dayUsd)}</div>
              <div class="cal-count">${tokens.length}T</div>
              <div class="cal-chips">
                ${tokens.slice(0,3).map(t=>`<span class="cal-chip">${t.symbol}</span>`).join('')}
                ${tokens.length>3?`<span class="cal-more">+${tokens.length-3}</span>`:''}
              </div>`:''}
          </div>`;
        }).join('')}
      </div>
      ${state.selectedDay && grouped[state.selectedDay] ? `
        <div class="day-detail">
          <div class="day-detail-header">
            <div class="day-detail-title">${new Date(state.selectedDay).toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}</div>
            <button class="close-btn" onclick="setState({selectedDay:null})">close ✕</button>
          </div>
          ${renderTable(sortTokens(grouped[state.selectedDay]))}
        </div>` : ''}
    ` : `
      ${sortedDates.length === 0 ? '<div class="empty">No events match current filters</div>' :
        sortedDates.map(dk => {
          const tokens = sortTokens(grouped[dk]);
          const dayUsd = tokens.reduce((s,t)=>s+t.next_unlock_usd,0);
          const cfg = RISK[topRisk(tokens)];
          return `<div class="list-date-block">
            <div class="list-date-header">
              <div style="display:flex;gap:10px;align-items:center">
                <div class="legend-dot" style="background:${cfg.color}"></div>
                <span class="list-date-label">${new Date(dk).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'})}</span>
              </div>
              <span class="list-date-total">${fmt(dayUsd)} · ${tokens.length} token${tokens.length>1?'s':''}</span>
            </div>
            ${renderTable(tokens)}
          </div>`;
        }).join('')}
    `}
  `;
}

function renderTable(tokens) {
  return `<div class="table-wrap"><table>
    <thead><tr>
      <th></th><th>Token</th><th>Price</th><th>24h</th><th>Unlock $</th><th>Tokens</th><th>% Circ</th><th>% Supply</th><th>Allocation</th>
    </tr></thead>
    <tbody>
      ${tokens.map(t => {
        const risk = getRisk(t.next_unlock_usd, t.pct_circ);
        const cfg  = RISK[risk];
        const barW = Math.min((t.pct_circ/8)*100, 100);
        const chg  = t.price_change_24h;
        return `<tr>
          <td><div class="td-risk"><div class="td-risk-dot" style="background:${cfg.color}"></div><span class="td-risk-label" style="color:${cfg.color}">${cfg.label}</span></div></td>
          <td><div class="td-symbol">${t.symbol}</div><div class="td-name">${t.name}</div></td>
          <td style="color:#999">$${fmtPrice(t.price)}</td>
          <td style="color:${chg==null?'#555':chg>=0?'var(--green)':'#cc4444'}">${chg!=null?(chg>=0?'+':'')+chg.toFixed(2)+'%':'—'}</td>
          <td class="td-usd">${fmt(t.next_unlock_usd)}</td>
          <td style="color:#777">${fmtTokens(t.next_unlock_tokens)}</td>
          <td><div class="td-bar-wrap"><div class="td-bar-bg"><div class="td-bar-fill" style="width:${barW}%;background:${cfg.color}"></div></div><span style="color:${cfg.color}">${fmtPct(t.pct_circ)}</span></div></td>
          <td style="color:#666">${fmtPct(t.pct_supply)}</td>
          <td class="td-alloc">${t.allocation_type||'—'}</td>
        </tr>`;
      }).join('')}
    </tbody>
  </table></div>`;
}

function setState(updates) { Object.assign(state, updates); render(); }
function toggleDay(key) { setState({ selectedDay: state.selectedDay === key ? null : key }); }

render();
</script>
</body>
</html>
